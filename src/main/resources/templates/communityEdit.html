<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>커뮤니티 게시글 수정</title>
</head>
<style>
    #img-selector {display: none;}
    div#editor_text {padding: 16px 24px; border: 1px solid #D6D6D6; border-radius: 4px;}
    #editor img { max-width: 100%; }
    button.active { background-color: #999999; color: #FFF; }
    #editor_text {display: inline;}
</style>
<body>
<div>
    <p th:text="'작성날짜 : ' + ${community.createdAt} ? ${#temporals.format(community.createdAt,'yyyy-MM-dd HH:mm')} : ${community.createdAt}"></p>
    <p th:text="'조회수 : ' + ${community.viewCounts}"></p>
    <p th:text="'작성자 : ' + ${community.userName}"></p>

    <form th:action="@{/community/edit/{id}(id = ${community.id})}" method="POST" enctype="multipart/form-data">
        <input type="hidden" name="_method" value="PUT">
        <label for="inputTitle">제목</label>
        <input type="text" name="community_title" id="inputTitle" th:value="${community.community_title}"><br>
        <input id="img-selector" type="file" name="attachFile"/>
        <div class="editor-menu">
            <button id="btn-bold"><b>B</b></button>
            <button id="btn-italic"><i>I</i></button>
            <button id="btn-underline"><u>U</u></button>
            <button id="btn-image">IMG</button>
        </div>
        <div id="editor">
            <div id="editor_text" th:text="${community.community_contents}" contenteditable="true">
            </div>
            <div id="existingImg" th:if="${community.imgWhether} == true">
                <img th:src="|/image/${community.getUploadFile().getImagePath()}|">
            </div>
        </div>
        <input type="hidden" name="community_contents" id="inputContent">
        <input type="submit" value="등록" onclick="getContents()">
        <a href="/list" value="취소">취소</a>
    </form>

</div>
<script>
    const editor = document.getElementById('editor');
    const btnBold = document.getElementById('btn-bold');
    const btnItalic = document.getElementById('btn-italic');
    const btnUnderline = document.getElementById('btn-underline');
    const btnImage = document.getElementById('btn-image');
    const imageSelector = document.getElementById('img-selector');
    const editorText = document.getElementById('editor_text');
    const inputContent = document.getElementById('inputContent');
    const existingImg = document.getElementById('existingImg');
    // const boldWhether = false;
    // const italicWhether = false;
    // const underlineWhether = false;

    btnBold.addEventListener('click', function (e) {
        setStyle('bold');
        e.preventDefault();
    });

    btnItalic.addEventListener('click', function (e) {
        setStyle('italic');
        e.preventDefault();
    });

    btnUnderline.addEventListener('click', function (e) {
        setStyle('underline');
        e.preventDefault();
    });

    btnImage.addEventListener('click', function (e) {
        imageSelector.click();
        e.preventDefault();
    });

    editor.addEventListener('mousedown', function (e) {
        document.execCommand(style);
        checkStyle();
        e.preventDefault();
    });

    function setStyle(style) {
        document.execCommand(style);
        focusEditor();
    }

    function focusEditor() {
        editor.focus({preventScroll: true});
    }

    imageSelector.addEventListener('change', function (e) {
        const files = e.target.files;
        if (!!files) {
            insertImageDate(files[0]);
            existingImg.style.display = 'none';
        }
    });

    function insertImageDate(file) {
        const reader = new FileReader();
        reader.addEventListener('load', function (e) {
            focusEditor();
            document.execCommand('insertImage', false, `${reader.result}`);
        });
        reader.readAsDataURL(file);
    }

    function checkStyle() {
        if (isStyle('bold')) {
            btnBold.classList.add('active');
        } else {
            btnBold.classList.remove('active');
        } if (isStyle('italic')) {
            btnItalic.classList.add('active');
        } else{
            btnItalic.classList.remove('active');
        } if (isStyle('underline')) {
            btnUnderline.classList.add('active');
        } else {
            btnUnderline.classList.remove('active');
        }
    }

    function isStyle(style) {
        return document.queryCommandState(style);
    }

    function getContents() {
        inputContent.value = editorText.innerText;
        return true;
    }

</script>
</body>
</html>